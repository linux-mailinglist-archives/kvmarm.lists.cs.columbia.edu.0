Return-Path: <kvmarm-bounces@lists.cs.columbia.edu>
X-Original-To: lists+kvmarm@lfdr.de
Delivered-To: lists+kvmarm@lfdr.de
Received: from mm01.cs.columbia.edu (mm01.cs.columbia.edu [128.59.11.253])
	by mail.lfdr.de (Postfix) with ESMTP id 7684D59FD2D
	for <lists+kvmarm@lfdr.de>; Wed, 24 Aug 2022 16:25:16 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by mm01.cs.columbia.edu (Postfix) with ESMTP id 1C75C4D061;
	Wed, 24 Aug 2022 10:25:15 -0400 (EDT)
X-Virus-Scanned: at lists.cs.columbia.edu
X-Spam-Flag: NO
X-Spam-Score: -1.789
X-Spam-Level: 
X-Spam-Status: No, score=-1.789 required=6.1 tests=[BAYES_00=-1.9,
	DKIM_SIGNED=0.1, T_DKIM_INVALID=0.01, URIBL_BLOCKED=0.001]
	autolearn=unavailable
Authentication-Results: mm01.cs.columbia.edu (amavisd-new); dkim=softfail
	(fail, message has been altered) header.i=@kernel.org
Received: from mm01.cs.columbia.edu ([127.0.0.1])
	by localhost (mm01.cs.columbia.edu [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id ozinc1aaBf-T; Wed, 24 Aug 2022 10:25:14 -0400 (EDT)
Received: from mm01.cs.columbia.edu (localhost [127.0.0.1])
	by mm01.cs.columbia.edu (Postfix) with ESMTP id AF95D4D04E;
	Wed, 24 Aug 2022 10:25:13 -0400 (EDT)
Received: from localhost (localhost [127.0.0.1])
 by mm01.cs.columbia.edu (Postfix) with ESMTP id E162D4CFAB
 for <kvmarm@lists.cs.columbia.edu>; Wed, 24 Aug 2022 10:25:12 -0400 (EDT)
X-Virus-Scanned: at lists.cs.columbia.edu
Received: from mm01.cs.columbia.edu ([127.0.0.1])
 by localhost (mm01.cs.columbia.edu [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id DYO69ZUByhGm for <kvmarm@lists.cs.columbia.edu>;
 Wed, 24 Aug 2022 10:25:11 -0400 (EDT)
Received: from ams.source.kernel.org (ams.source.kernel.org [145.40.68.75])
 by mm01.cs.columbia.edu (Postfix) with ESMTPS id A04B64CFA3
 for <kvmarm@lists.cs.columbia.edu>; Wed, 24 Aug 2022 10:25:11 -0400 (EDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested)
 by ams.source.kernel.org (Postfix) with ESMTPS id 216FFB8254D;
 Wed, 24 Aug 2022 14:25:10 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id B45EEC433C1;
 Wed, 24 Aug 2022 14:25:08 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
 s=k20201202; t=1661351108;
 bh=GlyJJ9dV5dcNN4e8F/+zW4aKoVpKrRpQG5FduS6xj60=;
 h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
 b=RlOFCFyOYvgDsmtvh7bI4fnzpALdN2M/t7Sdx3OBkKjuNIOEGaxCSeasH5M/MQcVu
 39MlyXzAx5P4sTw6vHcANvoZt5XNpo4DlF7c3sYHlUc18EhnOJ+Nx/MvsFzgmvBHY4
 mnjdD22AawdV/zG7YInQPGZCdQ59QpasRPsWlEDIns2MvGoYCbBB1Zlc8Zx17VlJKx
 WlpiSr2SvuWNUu+CiU1aCrccEOnvIj7LHy6SiOm7h2HB/+9dhcnJIKX7ihFSu2bagl
 8lmZ+3PVbzSvTHGsjmudsOHkifF0MknUFCc1OryZ69NDWLBrFdNJWFGyy08RVV1UqF
 GXox+Ellgocog==
Received: from [12.191.126.171] (helo=wait-a-minute.misterjones.org)
 by disco-boy.misterjones.org with esmtpsa (TLS1.3) tls
 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (Exim 4.95)
 (envelope-from <maz@kernel.org>) id 1oQrJa-005SYH-2A;
 Wed, 24 Aug 2022 15:25:06 +0100
Date: Wed, 24 Aug 2022 15:24:57 +0100
Message-ID: <87zgftra6e.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Ryan Roberts <ryan.roberts@arm.com>
Subject: Re: [PATCH v7 4/4] KVM: arm64/mmu: count KVM s2 mmu usage in
 secondary pagetable stats
In-Reply-To: <319904e0-3722-8ab1-cf74-491b9c32e23b@arm.com>
References: <20220823004639.2387269-1-yosryahmed@google.com>
 <20220823004639.2387269-5-yosryahmed@google.com>
 <319904e0-3722-8ab1-cf74-491b9c32e23b@arm.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
X-SA-Exim-Connect-IP: 12.191.126.171
X-SA-Exim-Rcpt-To: ryan.roberts@arm.com, yosryahmed@google.com, tj@kernel.org,
 hannes@cmpxchg.org, lizefan.x@bytedance.com, james.morse@arm.com,
 alexandru.elisei@arm.com, suzuki.poulose@arm.com, pbonzini@redhat.com,
 seanjc@google.com, vkuznets@redhat.com, wanpengli@tencent.com,
 jmattson@google.com, joro@8bytes.org, akpm@linux-foundation.org,
 mhocko@kernel.org, roman.gushchin@linux.dev, shakeelb@google.com,
 oupton@google.com, kvm@vger.kernel.org, linux-kernel@vger.kernel.org,
 Huang@google.com, shaoqin.huang@intel.com, linux-mm@kvack.org,
 cgroups@vger.kernel.org, kvmarm@lists.cs.columbia.edu,
 linux-arm-kernel@lists.infradead.org, nd@arm.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org);
 SAEximRunCond expanded to false
Cc: Wanpeng Li <wanpengli@tencent.com>, kvm@vger.kernel.org,
 Roman Gushchin <roman.gushchin@linux.dev>, Michal Hocko <mhocko@kernel.org>,
 Shaoqin <shaoqin.huang@intel.com>, linux-mm@kvack.org,
 Zefan Li <lizefan.x@bytedance.com>, kvmarm@lists.cs.columbia.edu,
 Joerg Roedel <joro@8bytes.org>, Shakeel Butt <shakeelb@google.com>,
 cgroups@vger.kernel.org, nd@arm.com, Huang@google.com,
 linux-arm-kernel@lists.infradead.org, Jim Mattson <jmattson@google.com>,
 Yosry Ahmed <yosryahmed@google.com>, Andrew Morton <akpm@linux-foundation.org>,
 linux-kernel@vger.kernel.org, Johannes Weiner <hannes@cmpxchg.org>,
 Tejun Heo <tj@kernel.org>, Paolo Bonzini <pbonzini@redhat.com>,
 Vitaly Kuznetsov <vkuznets@redhat.com>
X-BeenThere: kvmarm@lists.cs.columbia.edu
X-Mailman-Version: 2.1.14
Precedence: list
List-Id: Where KVM/ARM decisions are made <kvmarm.lists.cs.columbia.edu>
List-Unsubscribe: <https://lists.cs.columbia.edu/mailman/options/kvmarm>,
 <mailto:kvmarm-request@lists.cs.columbia.edu?subject=unsubscribe>
List-Archive: <https://lists.cs.columbia.edu/pipermail/kvmarm>
List-Post: <mailto:kvmarm@lists.cs.columbia.edu>
List-Help: <mailto:kvmarm-request@lists.cs.columbia.edu?subject=help>
List-Subscribe: <https://lists.cs.columbia.edu/mailman/listinfo/kvmarm>,
 <mailto:kvmarm-request@lists.cs.columbia.edu?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: kvmarm-bounces@lists.cs.columbia.edu
Sender: kvmarm-bounces@lists.cs.columbia.edu

On Wed, 24 Aug 2022 14:43:43 +0100,
Ryan Roberts <ryan.roberts@arm.com> wrote:
> 
> > Count the pages used by KVM in arm64 for stage2 mmu in memory stats
> > under secondary pagetable stats (e.g. "SecPageTables" in /proc/meminfo)
> > to give better visibility into the memory consumption of KVM mmu in a
> > similar way to how normal user page tables are accounted.
> > 
> > Signed-off-by: Yosry Ahmed <yosryahmed@google.com>
> > Reviewed-by: Oliver Upton <oliver.upton@linux.dev>
> > Reviewed-by: Marc Zyngier <maz@kernel.org>
> > ---
> 
> I see that you are not including the memory reserved for the host
> stage2 table when using protected KVM. Is this something worth adding?
> (See arch/arm64/kvm/pkvm.c:kvm_hyp_reserve()).
> 
> This reservation is done pretty early on in bootmem_init() so not sure
> if this could cause some init ordering issues that might be tricky to
> solve though.

I also don't see what this buys us. This memory can't be reclaimed,
and is not part of KVM's job for the purpose of running guests, which
is what this series is about.

If anything, it should be accounted separately.

	M.

-- 
Without deviation from the norm, progress is not possible.
_______________________________________________
kvmarm mailing list
kvmarm@lists.cs.columbia.edu
https://lists.cs.columbia.edu/mailman/listinfo/kvmarm
